# Relatório de Estudos

**Nome do Estagiário:** Melina Nogueira  
**Data:** 02/09/2024

## **Índice**  
1. **[Resumo](#resumo)**
2. **[Tarefa 2](#tarefa-2)**

    2.1. **[O que foi feito](#o-que-foi-feito)**

    2.2. **[Comandos](#comandos)**

    2.3. **[Explicação](#explicacao)**

---

## Resumo

Foi realizado duas tarefas utilizando Hive, onde não houve muitas dificuldades na estrutura por conta de sua semelhança com o SQL. Apesar desta facilidade, foi necessário pesquisas para conseguir filtrar alguns dados, muitas dessas dificuldades foi na realização da *tarefa 2*.

---

## Tarefa 2 

Script: [tarefa 2](tarefa2.sql)  

### O que foi feito
- Li o Readme da tarefa 2, identifiquei o que está sendo pedido e baixei as planilhas;
- Comando para conectar o minIO com Zeppelin;
- Criei tabela de `campaigns` e `purchases`;
- Importei os dados das planilhas nas tabelas; 
- Criei a tabela `consolidated_table` com as colunas solicitidas;
- Preenchi as colunas da tabela, depois de muita dificuldade, principalmente para calcular o `total_price`, `date_today` e `anomes_today`.

### Comandos

**Conectando minIO**
``` SQL
%hive
SET fs.s3a.access.key=minioadmin;
SET fs.s3a.secret.key=minioadmin;
SET fs.s3a.endpoint=http://localhost:9001;
SET fs.s3a.path.style.access=true
```

**Criando tabela campaigns**
``` SQL
%hive
CREATE EXTERNAL TABLE campaigns (
    id_campaign STRING,
    column_campaing STRING,
    type_campaign STRING,
    days_valid INT,
    data_campaign STRING,
    channel STRING,
    return_status STRING,
    return_date STRING,
    client_id STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE
LOCATION 's3a://tarefa1/'
TBLPROPERTIES ("skip.header.line.count"="1")
``` 

**Criando tabela purchases**
```SQL
%hive
CREATE EXTERNAL TABLE purchases (
    purchase_id STRING,
    product_name STRING,
    product_id STRING,
    amount DECIMAL(10, 2),
    price DECIMAL(10, 2),
    discount_applied BOOLEAN,
    payment_method STRING,
    purchase_datetime STRING,
    purchase_location STRING,
    client_id STRING
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE
LOCATION 's3a://tarefa2/'
TBLPROPERTIES ("skip.header.line.count"="1")
```

**Carregando dados na tabela campaigns**
```SQL
%hive
LOAD DATA INPATH 's3a://tarefa1/campaigns_2023_hist.csv'
INTO TABLE campaigns
```

**Carregando dados na tabela purchases**
```SQL
%hive
LOAD DATA INPATH 's3a://tarefa2/purchases_2023.csv'
INTO TABLE purchases
```

**Criando tabela consolidated_table**
```SQL
%hive
CREATE TABLE consolidated_table (
    client_id STRING,
    total_price DECIMAL(10, 2),
    most_purchase_location STRING,
    first_purchase STRING,
    last_purchase STRING,
    most_campaign STRING,
    quantity_error INT,
    date_today STRING,
    anomes_today INT
)
```
**Preenchendo a tabela consolidated_table**
```SQL
%hive
INSERT INTO TABLE consolidated_table
SELECT
    c.client_id AS client_id,
    SUM(p.price * p.amount * (CASE WHEN COALESCE(p.discount_applied, false) THEN 0.9 ELSE 1 END)) AS total_price,
    MAX(p.purchase_location) AS most_purchase_location,
    MIN(p.purchase_datetime) AS first_purchase,
    MAX(p.purchase_datetime) AS last_purchase,
    MAX(c.type_campaign) AS most_campaign,
    COUNT(CASE WHEN c.return_status = 'error' THEN 1 ELSE NULL END) AS quantity_error,
    FROM_UNIXTIME(UNIX_TIMESTAMP(), 'yyyy-MM-dd') AS date_today,
    FROM_UNIXTIME(UNIX_TIMESTAMP(), 'MMyyyy') AS anomes_today
FROM 
    purchases p
JOIN 
    campaigns c ON p.client_id = c.client_id
GROUP BY 
    c.client_id
```

### Explicação

- `column_campaing` esta coluna foi criada para não comprometer a estrutura, pois a tabela passada para nós, estava com uma coluna a menos, impossibilitando de saber do que se tratava.

- `TBLPROPERTIES ("skip.header.line.count"="1")` pula uma linha, para que não pegue a linha com os nomes das colunas;

- `DECIMAL(10, 2)` retorna apenas duas casas decimais;

- `c.client_id AS client_id` seleciona a coluna client_id do campaigns e passa os dados para a coluna client_id do consolidated_table;

- `SUM(p.price * p.amount * (CASE WHEN COALESCE(p.discount_applied, false) THEN 0.9 ELSE 1 END)) AS total_price` 
    - Primeiro é feito a multiplicação do preço do item pela quantidade comprada, obtendo o valor bruto da compra
    - A função `COALESCE` substitui valores nulos na coluna discount_applied pelo valor false;
    - A expressão `(CASE WHEN COALESCE(p.discount_applied, false) THEN 0.9 ELSE 1 END)) AS total_price` aplica um desconto de 10% se o desconto foi aplicado (se discount_applied é true), porém se não há desconto o valor é multiplicado por 1.

- `MIN` e `MAX` são usados para descobrir o maior ou o mais recente valor;

- `COUNT(CASE WHEN c.return_status = 'error' THEN 1 ELSE NULL END) AS quantity_error` conta a quantidade de erros, caso na coluna return_status apareça 'error' ele incrementa 1, caso contrário ele retorna null;

- `UNIX_TIMESTAMP()` retorna a data atual;

- `FROM_UNIXTIME()` formata o dado como 'yyyy-MM-dd'.
---
### **Desafios Encontrados:**  
- Trabalhar com funções;
- Trabalhar com formatação de data;
- Realizar cálculos.

---